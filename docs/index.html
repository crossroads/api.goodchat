<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>api.goodchat - v1.0.0</title>
	<meta name="description" content="Documentation for api.goodchat - v1.0.0">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/main.css">
	<script async src="assets/js/search.js" id="search-script"></script>
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="assets/js/search.json" data-base=".">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="index.html" class="title">api.goodchat - v1.0.0</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-externals" checked />
							<label class="tsd-widget" for="tsd-filter-externals">Externals</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<h1>api.goodchat - v1.0.0</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<a href="#goodchat-api" id="goodchat-api" style="color: inherit; text-decoration: none;">
					<h1>Goodchat API</h1>
				</a>
				<p><a href="https://forthebadge.com"><img src="https://forthebadge.com/images/badges/made-with-typescript.svg" alt="forthebadge"></a>
				<a href="https://forthebadge.com"><img src="https://forthebadge.com/images/badges/built-with-love.svg" alt="forthebadge"></a></p>
				<p><a href="https://codecov.io/gh/crossroads/api.goodchat"><img src="https://codecov.io/gh/crossroads/api.goodchat/branch/main/graph/badge.svg?token=16160ETKGA" alt="codecov"></a></p>
				<p>GoodChat API is a standalone <a href="https://nodejs.org">node.js</a> web service allowing easy integration with <a href="https://smooch.io">smooch.io</a></p>
				<!-- START doctoc generated TOC please keep comment here to allow auto update -->
				<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
				<ul>
					<li><a href="#design-notes">Design notes</a><ul>
							<li><a href="#features">Features</a></li>
						</ul>
					</li>
					<li><a href="#documentation">Documentation</a></li>
					<li><a href="#prerequisites">Prerequisites</a><ul>
							<li><a href="#dependencies">Dependencies</a></li>
							<li><a href="#sunshine-conversations">Sunshine Conversations</a><ul>
									<li><a href="#credentials">Credentials</a></li>
									<li><a href="#terminology">Terminology</a></li>
									<li><a href="#guides">Guides</a></li>
									<li><a href="#steps">Steps</a></li>
								</ul>
							</li>
						</ul>
					</li>
					<li><a href="#running-the-server">Running the server</a><ul>
							<li><a href="#manually">Manually</a></li>
							<li><a href="#on-top-of-an-existing-koa-app">On top of an existing Koa app</a></li>
							<li><a href="#using-the-ready-made-cli-script">Using the ready-made CLI script</a></li>
							<li><a href="#running-in-development-mode-with-autoreload">Running in development mode (with autoreload)</a><ul>
									<li><a href="#ngrok">Ngrok</a></li>
								</ul>
							</li>
						</ul>
					</li>
					<li><a href="#cli-configuration">CLI Configuration</a><ul>
							<li><a href="#environment-variables">Environment variables</a></li>
						</ul>
					</li>
					<li><a href="#testing">Testing</a></li>
					<li><a href="#database">Database</a><ul>
							<li><a href="#migrations">Migrations</a></li>
						</ul>
					</li>
					<li><a href="#license">License</a></li>
				</ul>
				<!-- END doctoc generated TOC please keep comment here to allow auto update -->
				<a href="#design-notes" id="design-notes" style="color: inherit; text-decoration: none;">
					<h3>Design notes</h3>
				</a>
				<p>The main purpose of Goodchat&#39;s is to integrate multiple chat channels to the <a href="https://goodcity.hk">GoodCity Project</a>, allowing people to donate goods directly via their existing channels.</p>
				<p>That said, GoodChat was designed as a generic and reusable product and therefore holds <em>no</em> shared business logic with the GoodCity. We intend this project, and therefore the code to be:</p>
				<ul>
					<li>Generic</li>
					<li>Reusable</li>
					<li>Configurable</li>
				</ul>
				<a href="#features" id="features" style="color: inherit; text-decoration: none;">
					<h4>Features</h4>
				</a>
				<ul>
					<li><input checked="" disabled="" type="checkbox"> Integration with Sunshine Conversations</li>
					<li><input checked="" disabled="" type="checkbox"> Webhooks support</li>
					<li><input disabled="" type="checkbox"> Live subscriptions support (notifications, new messages)</li>
					<li><input disabled="" type="checkbox"> Configurable Push Notification support</li>
					<li><input disabled="" type="checkbox"> REST/GQL Chat API</li>
					<li><input checked="" disabled="" type="checkbox"> Configurable authentication methods (allowing easy integration with existing systems)</li>
				</ul>
				<img src="./design/goodchat_integration.png" alt="drawing" width="700"/>
				<a href="#documentation" id="documentation" style="color: inherit; text-decoration: none;">
					<h2>Documentation</h2>
				</a>
				<p>The code-generated documentation can be accessed <a href="https://crossroads.github.io/api.goodchat/">here</a></p>
				<p>You can re-generate the documentation using the following npm script:</p>
				<pre><code class="language-bash"><span style="color: #000000">$&gt; npm run document</span>
</code></pre>
				<p>Updating the README table of contents:</p>
				<pre><code class="language-bash"><span style="color: #000000">$&gt; npm run doctoc</span>
</code></pre>
				<a href="#prerequisites" id="prerequisites" style="color: inherit; text-decoration: none;">
					<h2>Prerequisites</h2>
				</a>
				<a href="#system-requirements" id="system-requirements" style="color: inherit; text-decoration: none;">
					<h3>System requirements</h3>
				</a>
				<ul>
					<li>Node 14.x</li>
					<li>NPM 7+</li>
				</ul>
				<p>NPM 7 or above is required in order to handle peer-dependencies of the apollo server. An older version of NPM can be used but it may require you to install some modules manually</p>
				<a href="#dependencies" id="dependencies" style="color: inherit; text-decoration: none;">
					<h3>Dependencies</h3>
				</a>
				<p>Install the node dependencies using</p>
				<pre><code class="language-bash"><span style="color: #000000">$&gt; npm install</span>
</code></pre>
				<a href="#sunshine-conversations" id="sunshine-conversations" style="color: inherit; text-decoration: none;">
					<h3>Sunshine Conversations</h3>
				</a>
				<a href="#credentials" id="credentials" style="color: inherit; text-decoration: none;">
					<h4>Credentials</h4>
				</a>
				<p>Running GoodChat requires the following Sunshine Conversation credentials:</p>
				<ul>
					<li>An APP ID - Identifying which Sunshine app this is</li>
					<li>A Key ID - Acts as a username when authenticating to Sunshine</li>
					<li>A Key Secret - Acts as a password when authenticating to Sunshine</li>
				</ul>
				<a href="#terminology" id="terminology" style="color: inherit; text-decoration: none;">
					<h4>Terminology</h4>
				</a>
				<ul>
					<li>Smooch: The omnichat api used was previously known as Smooch, you may see that name in some places as it hasn&#39;t been fully renamed to &quot;Sunshine Conversations&quot; yet</li>
					<li>An integration: A chat service which connects to and integrates with Sunshine. e.g Whatsapp, Messenger, ...</li>
					<li>A custom integration: A chat service of our own which connects and integrates with Sunshine. GoodChat is a custom integration (it will auto-register itself)</li>
				</ul>
				<a href="#guides" id="guides" style="color: inherit; text-decoration: none;">
					<h4>Guides</h4>
				</a>
				<details>
					<summary>How to create a Sunshine Application</summary>
					<a href="#steps" id="steps" style="color: inherit; text-decoration: none;">
						<h5>Steps</h5>
					</a>
					<ol>
						<li>Login to your Sunshine Conversations account</li>
						<li>Head to your dashboard (<a href="https://app.smooch.io">https://app.smooch.io</a>)</li>
				<li>On the right side click on the <code>Create new app</code> button</details></li>
				</ol>
				<details>
					<summary>How to create a Sunshine ID/Secret Key pair</summary>
					<a href="#steps-1" id="steps-1" style="color: inherit; text-decoration: none;">
						<h4>Steps</h4>
					</a>
					<ol>
						<li>Once your app is created, click on it from your dashboard view</li>
						<li>On the app header bar, click on <code>Settings</code></li>
						<li>At the bottom of the settings page, you will find your api keys. Use the <code>Create new API key</code> action for a new one</li>
				<li>Write down the ID/Secret key pair, as well as the APP ID</details></li>
				</ol>
				<a href="#running-the-server" id="running-the-server" style="color: inherit; text-decoration: none;">
					<h2>Running the server</h2>
				</a>
				<a href="#manually" id="manually" style="color: inherit; text-decoration: none;">
					<h3>Manually</h3>
				</a>
				<p>You may create an instance of GoodChat, and start it manually as shown below</p>
				<pre><code class="language-typescript"><span style="color: #AF00DB">import</span><span style="color: #000000"> </span><span style="color: #001080">goodchat</span><span style="color: #000000">, { </span><span style="color: #001080">GoodChatAuthMode</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@goodcity/api.goodchat&#039;</span>

<span style="color: #0000FF">const</span><span style="color: #000000"> [</span><span style="color: #0070C1">app</span><span style="color: #000000">] = </span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #795E26">goodchat</span><span style="color: #000000">({</span>
<span style="color: #000000">  </span><span style="color: #001080">smoochAppId:</span><span style="color: #000000">            </span><span style="color: #A31515">&#039;sample_app_id&#039;</span><span style="color: #000000">,</span>
<span style="color: #000000">  </span><span style="color: #001080">smoochApiKeyId:</span><span style="color: #000000">         </span><span style="color: #A31515">&#039;sample_api_key_id&#039;</span><span style="color: #000000">,</span>
<span style="color: #000000">  </span><span style="color: #001080">smoochApiKeySecret:</span><span style="color: #000000">     </span><span style="color: #A31515">&#039;sample_api_key_secret&#039;</span><span style="color: #000000">,</span>
<span style="color: #000000">  </span><span style="color: #001080">goodchatHost:</span><span style="color: #000000">           </span><span style="color: #A31515">&#039;localhost:8000&#039;</span><span style="color: #000000">,</span>
<span style="color: #000000">  </span><span style="color: #001080">auth:</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #001080">mode:</span><span style="color: #000000"> </span><span style="color: #001080">GoodChatAuthMode</span><span style="color: #000000">.</span><span style="color: #0070C1">NONE</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">})</span>

<span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">listen</span><span style="color: #000000">(</span><span style="color: #098658">8000</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">  </span><span style="color: #001080">console</span><span style="color: #000000">.</span><span style="color: #795E26">info</span><span style="color: #000000">(</span><span style="color: #A31515">&#039;Goodchat is running&#039;</span><span style="color: #000000">);</span>
<span style="color: #000000">})</span>
</code></pre>
				<a href="#using-the-ready-made-cli-script" id="using-the-ready-made-cli-script" style="color: inherit; text-decoration: none;">
					<h3>Using the ready-made CLI script</h3>
				</a>
				<p>An pre-written startup script exists under the <code>/bin</code> folder to run the server. It can be used easily thanks to the following npm scripts:</p>
				<p>Build the project</p>
				<pre><code class="language-bash"><span style="color: #000000">$&gt; npm run build</span>
</code></pre>
				<p>Run it</p>
				<pre><code class="language-bash"><span style="color: #000000">$&gt; npm run start</span>
</code></pre>
				<a href="#running-in-development-mode-with-autoreload" id="running-in-development-mode-with-autoreload" style="color: inherit; text-decoration: none;">
					<h3>Running in development mode (with autoreload)</h3>
				</a>
				<pre><code class="language-bash"><span style="color: #000000">$&gt; npm run dev</span>
</code></pre>
				<a href="#ngrok" id="ngrok" style="color: inherit; text-decoration: none;">
					<h4>Ngrok</h4>
				</a>
				<p>When running the server in a development environment (NODE_ENV=development), the startup script will initiate an <a href="https://www.npmjs.com/package/ngrok">ngrok</a> tunnel in order to have callable webhooks.</p>
				<a href="#cli-configuration" id="cli-configuration" style="color: inherit; text-decoration: none;">
					<h2>CLI Configuration</h2>
				</a>
				<a href="#environment-variables" id="environment-variables" style="color: inherit; text-decoration: none;">
					<h3>Environment variables</h3>
				</a>
				<p>When running the server from an NPM script, the server can be configured using the following environment variables</p>
				<ul>
					<li><code>NODE_ENV</code>  - defines the environment it&#39;s running on. Options:<ul>
							<li><code>production</code></li>
							<li><code>staging</code></li>
							<li><code>development</code> (default)</li>
						</ul>
					</li>
					<li><code>NO_AUTH</code> - if set to &quot;true&quot; or &quot;yes&quot;, will no support any form of authentication (good for testing)</li>
				</ul>
				<a href="#graphql" id="graphql" style="color: inherit; text-decoration: none;">
					<h2>GraphQL</h2>
				</a>
				<a href="#using-the-playground" id="using-the-playground" style="color: inherit; text-decoration: none;">
					<h3>Using the playground</h3>
				</a>
				<ul>
					<li>Open <a href="http://localhost:8000/graphql"></a> on your browser to view the playground</li>
					<li>Make sure the Auth API is running, the default DEV environment will use localhost:3000 as an auth endpoint</li>
					<li>At the bottom of the playground, set the HTTP Headers to include an Authorization header</li>
					<li>Write your queries</li>
					<li>Press play</li>
				</ul>
				<p>Here&#39;s an example query to get you started</p>
				<pre><code class="language-gql">query Conversations {
  conversations {
    id
    type
    messages {
      id
      content
    }
  }
}
</code></pre>
				<a href="#testing" id="testing" style="color: inherit; text-decoration: none;">
					<h2>Testing</h2>
				</a>
				<p>Goodchat specs are written using <a href="https://www.npmjs.com/package/mocha">Mocha</a>, they are all located under the <code>spec/</code> folder.</p>
				<p>Run the specs using the following command:</p>
				<pre><code class="language-bash"><span style="color: #000000">$&gt; npm run </span><span style="color: #795E26">test</span>
</code></pre>
				<a href="#database" id="database" style="color: inherit; text-decoration: none;">
					<h2>Database</h2>
				</a>
				<a href="#migrations" id="migrations" style="color: inherit; text-decoration: none;">
					<h3>Migrations</h3>
				</a>
				<p>Please refer to the <a href="https://www.prisma.io/docs/concepts/components/prisma-migrate/prisma-migrate-flows">Pristma Migrate Flow</a></p>
				<p>A set of npm scripts are available for the common actions:</p>
				<ul>
					<li><code>db:migrate:new</code> Creates a new migration (without applying it)</li>
					<li><code>db:migrate:dev</code> Applies migrations to the dev environment</li>
					<li><code>db:migrate:prod</code> Applies migrations on production (to be used in CD)</li>
				</ul>
				<a href="#authentication-modes" id="authentication-modes" style="color: inherit; text-decoration: none;">
					<h2>Authentication Modes</h2>
				</a>
				<a href="#none" id="none" style="color: inherit; text-decoration: none;">
					<h3>None</h3>
				</a>
				<p>This mode is present for development/testing purposes</p>
				<a href="#webhook" id="webhook" style="color: inherit; text-decoration: none;">
					<h3>Webhook</h3>
				</a>
				<img src="./design/webhook_auth.png" alt="drawing" width="900"/>
				<a href="#diagram" id="diagram" style="color: inherit; text-decoration: none;">
					<h3>Diagram</h3>
				</a>
				<img src="./design/dbdiagram.png" alt="drawing" width="900"/>
				<a href="#license" id="license" style="color: inherit; text-decoration: none;">
					<h2>License</h2>
				</a>
				<p>Copyright © 2020 by <a href="https://www.crossroads.org.hk">Crossroads Foundation Ltd</a></p>
				<p>All rights reserved. No part of this software may be reproduced, distributed, or transmitted in any form or by any means, including photocopying, recording, or other electronic or mechanical methods, without the prior written permission of Crossroads Foundation Ltd. For permission requests, write to Crossroads Foundation Ltd., addressed “Attention: CTO” using the general contact details found on <a href="https://www.crossroads.org.hk">www.crossroads.org.hk</a>.</p>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class=" ">
						<a href="modules.html">Modules</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/index.html">index</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_db.html">lib/db</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_initializers.html">lib/initializers</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_initializers_smooch.html">lib/initializers/smooch</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_middlewares_authenticate.html">lib/middlewares/authenticate</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_middlewares_i18n.html">lib/middlewares/i18n</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_middlewares_logs.html">lib/middlewares/logs</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_middlewares_rescue.html">lib/middlewares/rescue</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_routes_graphql.html">lib/routes/graphql</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_routes_graphql_resolvers.html">lib/routes/graphql/resolvers</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_routes_webhooks.html">lib/routes/webhooks</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_routes_webhooks_setup.html">lib/routes/webhooks/setup</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_abilities.html">lib/services/abilities</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_abilities_rules.html">lib/services/abilities/rules</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_auth_service.html">lib/services/auth_<wbr>service</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_conversation_service.html">lib/services/conversation_<wbr>service</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_customer_service.html">lib/services/customer_<wbr>service</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_events.html">lib/services/events</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_events_pubsub.html">lib/services/events/pubsub</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_events_webhooks_conversation_created.html">lib/services/events/webhooks/conversation_<wbr>created</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_events_webhooks_conversation_message.html">lib/services/events/webhooks/conversation_<wbr>message</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_services_i18n.html">lib/services/i18n</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_typings_goodchat.html">lib/typings/goodchat</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_typings_lang.html">lib/typings/lang</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_typings_sunshine.html">lib/typings/sunshine</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_typings_webhook_types.html">lib/typings/webhook_<wbr>types</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_utils_assertions.html">lib/utils/assertions</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_utils_async.html">lib/utils/async</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_utils_env.html">lib/utils/env</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_utils_errors.html">lib/utils/errors</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_utils_http.html">lib/utils/http</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/lib_utils_logger.html">lib/utils/logger</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li>
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
				<li class="tsd-kind-function tsd-has-type-parameter"><span class="tsd-kind-icon">Function with type parameter</span></li>
				<li class="tsd-kind-type-alias"><span class="tsd-kind-icon">Type alias</span></li>
				<li class="tsd-kind-type-alias tsd-has-type-parameter"><span class="tsd-kind-icon">Type alias with type parameter</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li>
				<li class="tsd-kind-interface tsd-has-type-parameter"><span class="tsd-kind-icon">Interface with type parameter</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-enum"><span class="tsd-kind-icon">Enumeration</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-class tsd-has-type-parameter"><span class="tsd-kind-icon">Class with type parameter</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="assets/js/main.js"></script>
</body>
</html>